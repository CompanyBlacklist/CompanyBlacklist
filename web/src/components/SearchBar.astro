---
import { config } from '../config.js';
---

<div class="search-container w-full max-w-2xl mx-auto relative">
  <div class="relative">
    <input
      type="text"
      id="search-input"
      placeholder="搜索公司名称或城市..."
      class="w-full px-4 py-3 pl-12 pr-12 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 shadow-sm hover:shadow-md focus:shadow-md"
      autocomplete="off"
      aria-autocomplete="list"
      aria-expanded="false"
      aria-haspopup="listbox"
      aria-controls="search-suggestions search-results"
    />
    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 transition-colors duration-200 focus-within:text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <div id="search-loading" class="absolute right-4 top-1/2 transform -translate-y-1/2 hidden">
      <svg class="w-5 h-5 text-primary animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
    </div>
    <button
      id="clear-search"
      class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors duration-200 hidden flex items-center justify-center w-5 h-5 rounded-full hover:bg-gray-100"
      aria-label="清除搜索"
    >
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
        <path fill-rule="evenodd" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
  <div id="search-results" class="mt-2 bg-white rounded-lg shadow-lg overflow-hidden hidden absolute left-0 right-0 z-50 w-full max-h-96 overflow-y-auto border border-gray-100 transition-all duration-200 ease-in-out transform origin-top scale-100 opacity-100"></div>
  <div id="search-suggestions" class="mt-2 bg-white rounded-lg shadow-lg overflow-hidden hidden absolute left-0 right-0 z-50 w-full border border-gray-100 transition-all duration-200 ease-in-out transform origin-top scale-100 opacity-100"></div>
</div>

<!-- 使用Astro支持的客户端脚本方式，将minisearch作为外部依赖 -->
<script>
  // 使用动态导入确保在客户端正确加载minisearch
  (async () => {
    const { default: MiniSearch } = await import('minisearch');
    
    // 配置变量
    const config = {
      api: {
        index: '/CompanyBlacklist/static_api/v1/_index.json',
        items: '/CompanyBlacklist/static_api/v1/items'
      },
      paths: {
        companyDetail: '/CompanyBlacklist/company'
      }
    };
    
    let miniSearch;
    let allCompanies = [];
    let searchHistory = [];
    const MAX_HISTORY = 5;
    
    // 定义初始化函数
    async function initSearch() {
      try {
        console.log('开始初始化搜索功能...');
        console.log('minisearch已导入:', MiniSearch);
        
        // 获取搜索数据
        console.log('开始获取搜索数据，API路径:', config.api.index);
        const response = await fetch(config.api.index);
        if (!response.ok) {
          throw new Error(`Failed to fetch index data: ${response.status}`);
        }
        const indexData = await response.json();
        console.log('搜索数据获取成功，共', indexData.length, '条记录');

        // 获取所有公司数据，添加错误处理
        console.log('开始获取所有公司数据...');
        const companyPromises = indexData.map(async (item) => {
          try {
            const prefix = Math.floor(item.id / 100);
            const companyUrl = `${config.api.items}/${prefix}/${item.id}.json`;
            
            const response = await fetch(companyUrl);
            if (!response.ok) {
              throw new Error(`Failed to fetch company ${item.id}: ${response.status}`);
            }
            const companyData = await response.json();
            return companyData;
          } catch (error) {
            console.error(`获取公司${item.id}数据失败:`, error);
            return null;
          }
        });

        const companies = await Promise.all(companyPromises);
        // 过滤掉null值
        allCompanies = companies.filter(company => company !== null);
        console.log('所有公司数据获取成功，共', allCompanies.length, '家有效公司');
        
        // 实例化
        console.log('开始实例化MiniSearch...');
        miniSearch = new MiniSearch({
          fields: ['name', 'city', 'tags'], // 搜索字段
          storeFields: ['id', 'name', 'city', 'tags'], // 存储字段
          searchOptions: {
            prefix: true,
            fuzzy: 0.2,
            boost: { name: 2 }
          }
        });
        console.log('MiniSearch实例化成功:', miniSearch);

        // 添加文档
        miniSearch.addAll(allCompanies);
        console.log('文档添加成功，共', allCompanies.length, '家公司');
        
        // 加载搜索历史
        loadSearchHistory();
        console.log('搜索功能初始化成功！');
        
      } catch (err) {
        console.error('搜索功能初始化失败:', err);
      }
    }

    // 加载搜索历史
    function loadSearchHistory() {
      const history = localStorage.getItem('searchHistory');
      if (history) {
        searchHistory = JSON.parse(history);
      }
    }

    // 保存搜索历史
    function saveSearchHistory(query) {
      // 移除重复项
      searchHistory = searchHistory.filter(item => item !== query);
      // 添加到开头
      searchHistory.unshift(query);
      // 限制历史记录数量
      if (searchHistory.length > MAX_HISTORY) {
        searchHistory = searchHistory.slice(0, MAX_HISTORY);
      }
      // 保存到 localStorage
      localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    }

    // 清除搜索历史
    function clearSearchHistory() {
      searchHistory = [];
      localStorage.removeItem('searchHistory');
      renderSuggestions('');
    }

    // 高亮搜索文本
    function highlightText(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
      return text.replace(regex, '<span class="bg-primary/20 text-primary font-medium">$1</span>');
    }

    // 转义正则表达式特殊字符
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // 渲染搜索建议
    function renderSuggestions(query) {
      const suggestionsContainer = document.getElementById('search-suggestions');
      const resultsContainer = document.getElementById('search-results');
      
      if (!query.trim()) {
        // 显示搜索历史
        if (searchHistory.length > 0) {
          const html = `
            <div class="p-3 bg-gradient-to-r from-primary/5 to-primary/10 border-b border-primary/20 flex justify-between items-center">
              <div class="flex items-center">
                <svg class="w-4 h-4 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span class="text-sm font-semibold text-gray-800">搜索历史</span>
              </div>
              <button id="clear-history" class="text-sm text-gray-500 hover:text-primary transition-colors duration-200">
                清除历史
              </button>
            </div>
            ${searchHistory.map(item => `
              <div class="p-3 hover:bg-primary/5 cursor-pointer search-history-item transition-colors duration-200 border-b border-gray-50 last:border-b-0">
                <div class="flex items-center justify-center">
                  <svg class="w-4 h-4 text-primary/50 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span class="text-gray-800">${item}</span>
                  <span class="ml-2 text-xs text-gray-400">历史记录</span>
                </div>
              </div>
            `).join('')}
          `;
          suggestionsContainer.innerHTML = html;
          suggestionsContainer.classList.remove('hidden');
          resultsContainer.classList.add('hidden');
          
          // 添加历史记录点击事件
          document.querySelectorAll('.search-history-item').forEach(item => {
            item.addEventListener('click', () => {
              const query = item.querySelector('span').textContent;
              document.getElementById('search-input').value = query;
              handleSearch({ target: { value: query } });
            });
          });
          
          // 添加清除历史按钮事件
          document.getElementById('clear-history').addEventListener('click', clearSearchHistory);
        } else {
          // 显示空状态
          const html = `
            <div class="p-6 text-center">
              <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
              <h3 class="text-lg font-medium text-gray-900 mb-1">暂无搜索历史</h3>
              <p class="text-sm text-gray-500">搜索公司名称或城市，开始您的职场避雷之旅</p>
            </div>
          `;
          suggestionsContainer.innerHTML = html;
          suggestionsContainer.classList.remove('hidden');
          resultsContainer.classList.add('hidden');
        }
        return;
      }
      
      // 显示实时搜索建议
      if (miniSearch) {
        const results = miniSearch.search(query, { limit: 5 });
        if (results.length > 0) {
          const html = `
            <div class="p-3 bg-gradient-to-r from-primary/5 to-primary/10 border-b border-primary/20">
              <div class="flex items-center">
                <svg class="w-4 h-4 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <span class="text-sm font-semibold text-gray-800">相关建议</span>
              </div>
            </div>
            ${results.map((result, index) => `
              <div class="p-3 hover:bg-primary/5 cursor-pointer search-suggestion-item transition-colors duration-200 border-b border-gray-50 last:border-b-0">
                <div class="flex items-center">
                  <svg class="w-4 h-4 text-primary/50 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                  <span class="text-gray-800">${highlightText(result.name, query)}</span>
                  ${result.city ? `<span class="ml-auto text-xs text-gray-400">${result.city}</span>` : ''}
                </div>
                ${result.tags.length > 0 ? `
                  <div class="mt-2 flex flex-wrap">
                    ${result.tags.slice(0, 2).map(tag => `<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700 mr-2">${tag}</span>`).join('')}
                    ${result.tags.length > 2 ? `<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700">+${result.tags.length - 2} 个标签</span>` : ''}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          `;
          suggestionsContainer.innerHTML = html;
          suggestionsContainer.classList.remove('hidden');
          resultsContainer.classList.add('hidden');
          
          // 添加搜索建议点击事件
          document.querySelectorAll('.search-suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
              const companyName = item.querySelector('span').textContent.replace(/<[^>]+>/g, '');
              document.getElementById('search-input').value = companyName;
              handleSearch({ target: { value: companyName } });
            });
          });
        } else {
          suggestionsContainer.classList.add('hidden');
        }
      }
    }

    // 渲染搜索结果
    function renderResults(results) {
      const resultsContainer = document.getElementById('search-results');
      
      if (results.length === 0) {
        resultsContainer.innerHTML = `
          <div class="p-6 text-center">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-1">未找到相关结果</h3>
            <p class="text-sm text-gray-500">尝试使用其他关键词或检查拼写</p>
          </div>
        `;
        return;
      }

      const html = results.map((result) => `
        <a href="${config.paths.companyDetail}/${result.id}" class="block p-4 hover:bg-primary/5 transition-colors duration-200 border-b border-gray-50 last:border-b-0 group">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="font-medium text-gray-900 group-hover:text-primary transition-colors truncate">${highlightText(result.name, document.getElementById('search-input').value)}</div>
              <div class="text-sm text-gray-500 mt-1 truncate">${result.city}</div>
            </div>
            <svg class="w-5 h-5 text-gray-400 mt-1 group-hover:text-primary transition-colors" fill="currentColor" viewBox="0 0 24 24">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <div class="flex flex-wrap mt-2">
            ${result.tags.map(tag => `<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 mr-2 mb-2 group-hover:bg-primary/10 group-hover:text-primary transition-colors">${tag}</span>`).join('')}
          </div>
        </a>
      `).join('');

      resultsContainer.innerHTML = html;
    }

    // 搜索处理
    function handleSearch(event) {
      const query = event.target.value.trim();
      const resultsContainer = document.getElementById('search-results');
      const suggestionsContainer = document.getElementById('search-suggestions');
      const clearButton = document.getElementById('clear-search');
      
      console.log('开始处理搜索请求，搜索关键词:', query);
      
      // 显示/隐藏清除按钮
      if (query) {
        clearButton.classList.remove('hidden');
        // 延迟显示结果，优先显示建议
        setTimeout(() => {
          if (miniSearch && document.activeElement === event.target) {
            console.log('开始搜索，miniSearch实例存在:', !!miniSearch);
            const results = miniSearch.search(query);
            console.log('搜索完成，共找到', results.length, '条结果');
            renderResults(results);
            resultsContainer.classList.remove('hidden');
            suggestionsContainer.classList.add('hidden');
          } else {
            console.log('搜索失败，miniSearch实例不存在或失去焦点');
          }
        }, 300);
      } else {
        console.log('搜索关键词为空，显示搜索历史');
        clearButton.classList.add('hidden');
        renderSuggestions('');
        resultsContainer.classList.add('hidden');
        return;
      }
    }

    // 清除搜索
    function clearSearch() {
      const input = document.getElementById('search-input');
      const resultsContainer = document.getElementById('search-results');
      const suggestionsContainer = document.getElementById('search-suggestions');
      const clearButton = document.getElementById('clear-search');
      
      input.value = '';
      resultsContainer.classList.add('hidden');
      clearButton.classList.add('hidden');
      renderSuggestions('');
      input.focus();
    }

    // 执行初始化
    initSearch();
    
    // 添加搜索事件监听
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (event) => {
      renderSuggestions(event.target.value);
      handleSearch(event);
    });
    searchInput.addEventListener('focus', () => renderSuggestions(searchInput.value));
    
    // 添加清除按钮事件监听
    document.getElementById('clear-search').addEventListener('click', clearSearch);
    
    // 点击外部关闭搜索结果
    document.addEventListener('click', (event) => {
      const searchContainer = document.querySelector('.search-container');
      const resultsContainer = document.getElementById('search-results');
      const suggestionsContainer = document.getElementById('search-suggestions');
      
      if (!searchContainer.contains(event.target)) {
        resultsContainer.classList.add('hidden');
        suggestionsContainer.classList.add('hidden');
      }
    });
    
    // 键盘导航支持
    let currentIndex = -1;
    let currentItems = [];
    
    searchInput.addEventListener('keydown', (event) => {
      const suggestionsContainer = document.getElementById('search-suggestions');
      const resultsContainer = document.getElementById('search-results');
      
      if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
        event.preventDefault();
        
        // 确定当前活动的容器
        let activeContainer;
        if (!suggestionsContainer.classList.contains('hidden')) {
          activeContainer = suggestionsContainer;
        } else if (!resultsContainer.classList.contains('hidden')) {
          activeContainer = resultsContainer;
        }
        
        if (activeContainer) {
          currentItems = activeContainer.querySelectorAll('.search-history-item, .search-suggestion-item, a');
          
          // 移除所有项的高亮
          currentItems.forEach(item => item.classList.remove('bg-primary/10', 'border-primary/20'));
          
          // 更新当前索引
          if (event.key === 'ArrowDown') {
            currentIndex = (currentIndex + 1) % currentItems.length;
          } else {
            currentIndex = (currentIndex - 1 + currentItems.length) % currentItems.length;
          }
          
          // 高亮当前项
          const currentItem = currentItems[currentIndex];
          currentItem.classList.add('bg-primary/10', 'border-primary/20');
          
          // 滚动到可见区域
          currentItem.scrollIntoView({ block: 'nearest' });
        }
      } else if (event.key === 'Enter') {
        // 如果有选中项，触发点击事件
        if (currentIndex >= 0 && currentItems.length > 0) {
          event.preventDefault();
          currentItems[currentIndex].click();
          currentIndex = -1;
        }
      } else if (event.key === 'Escape') {
        // 清除搜索
        clearSearch();
        currentIndex = -1;
      }
    });
    
    // 重置索引当失去焦点或点击外部
    document.addEventListener('click', (event) => {
      const searchContainer = document.querySelector('.search-container');
      if (!searchContainer.contains(event.target)) {
        currentIndex = -1;
      }
    });
  })();
</script>


