name: Check Sensitive Labels
on:
  issues:
    types: [labeled]

jobs:
  check-sensitive-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Check label permissions
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 定义标签权限映射
            // key: 标签名, value: 允许添加该标签的团队列表
            const labelPermissions = {
              // 初审标签 - 只有 volunteers（不包括 admins）
              'audit:verified': ['volunteers'],
              // 终审标签 - 只有 admins
              'admin:approved': ['admins'],
              // 申诉初审 - 只有 volunteers（不包括 admins）
              'appeal:verified': ['volunteers'],
              // 申诉终审 - 只有 admins
              'appeal:approved': ['admins'],
              // Bug 相关 - 只有 developers
              'type:bug': ['developers'],
              'bug:confirmed': ['developers'],
              'bug:fixed': ['developers'],
            };
            
            // 获取事件信息
            const { issue, label, sender } = context.payload;
            const { owner, repo } = context.repo;
            
            // 检查标签是否在权限列表中
            if (!labelPermissions[label.name]) {
              console.log(`标签 ${label.name} 不在权限控制列表中，跳过检查`);
              return;
            }
            
            const allowedTeams = labelPermissions[label.name];
            console.log(`检测到添加敏感标签: ${label.name} 由 ${sender.login} 添加`);
            console.log(`允许的团队: ${allowedTeams.join(', ')}`);
            
            try {
              // 获取发送者所属团队
              const response = await github.rest.teams.listForUserInOrg({
                username: sender.login,
                org: owner
              });
              
              const senderTeams = response.data.map(team => team.slug);
              console.log(`发送者所属团队: ${senderTeams.join(', ')}`);
              
              // 检查发送者是否属于允许的团队
              const hasPermission = allowedTeams.some(team => senderTeams.includes(team));
              
              if (!hasPermission) {
                console.log(`${sender.login} 没有权限添加 ${label.name} 标签，移除中...`);
                
                // 移除敏感标签
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: issue.number,
                  name: label.name
                });
                
                // 添加评论通知
                const teamNames = {
                  'volunteers': '志愿者',
                  'admins': '管理员',
                  'developers': '开发者'
                };
                const allowedTeamNames = allowedTeams.map(t => teamNames[t] || t).join('/');
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `@${sender.login} 您好，标签 \`${label.name}\` 只能由 **${allowedTeamNames}** 添加。该标签已被自动移除。`
                });
              } else {
                console.log(`${sender.login} 有权限添加 ${label.name} 标签`);
              }
            } catch (error) {
              console.error('处理标签权限时出错:', error.message);
            }
